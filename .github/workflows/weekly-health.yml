name: Weekly Health Check

on:
  schedule:
    - cron: "0 15 * * 1"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: weekly-health-check
  cancel-in-progress: false

jobs:
  production-readiness:
    runs-on: ubuntu-latest
    environment: production
    env:
      CI: true
      NODE_ENV: production
      DATABASE_URL: ${{ secrets.NEON_PROD_DATABASE_URL || secrets.NEON_PROD_DIRECT_URL }}
      NEXTAUTH_SECRET: ${{ secrets.PROD_NEXTAUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.PROD_BASE_URL }}
      BOTPASS_FROM_EMAIL: ${{ secrets.PROD_BOTPASS_FROM_EMAIL }}
      UPSTASH_REDIS_REST_URL: ${{ secrets.PROD_UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.PROD_UPSTASH_REDIS_REST_TOKEN }}
      OPENCLAW_PROVIDER_MODE: real
      OPENCLAW_ENDPOINT: ${{ secrets.PROD_OPENCLAW_ENDPOINT }}
      OPENCLAW_TOKEN: ${{ secrets.PROD_OPENCLAW_TOKEN }}
      OPENCLAW_BASE_PATH: /tools
      OPENCLAW_TIMEOUT_MS: "8000"
      OPENCLAW_MAX_RETRIES: "2"
      OPENCLAW_RETRY_BACKOFF_MS: "250"
      OPENCLAW_FALLBACK_TO_MOCK: "false"
      RESEND_API_KEY: ${{ secrets.PROD_RESEND_API_KEY }}
      SENTRY_DSN: ${{ secrets.PROD_SENTRY_DSN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Production env check
        run: pnpm env:check:prod

  production-http-smoke:
    runs-on: ubuntu-latest
    environment: production
    needs:
      - production-readiness
    env:
      BASE_URL: ${{ secrets.PROD_BASE_URL }}
    steps:
      - name: Verify base url secret
        run: |
          if [ -z "${BASE_URL:-}" ]; then
            echo "::error::Missing required secret: PROD_BASE_URL"
            exit 1
          fi

      - name: Smoke check pages
        run: |
          curl -fsS -L -m 15 "$BASE_URL/" >/dev/null
          curl -fsS -L -m 15 "$BASE_URL/zh-TW" >/dev/null
          curl -fsS -L -m 15 "$BASE_URL/zh-TW/events" >/dev/null

      - name: Smoke check API and DB connectivity
        run: |
          body="$(curl -fsS -m 15 "$BASE_URL/api/public/events")"
          echo "$body" | jq -e '.ok == true' >/dev/null
          echo "$body" | jq -e '.data | type == "array"' >/dev/null

  staging-http-smoke:
    runs-on: ubuntu-latest
    environment: staging
    env:
      BASE_URL: ${{ secrets.STAGING_BASE_URL }}
    steps:
      - name: Verify base url secret
        run: |
          if [ -z "${BASE_URL:-}" ]; then
            echo "::error::Missing required secret: STAGING_BASE_URL"
            exit 1
          fi

      - name: Smoke check pages
        run: |
          curl -fsS -L -m 15 "$BASE_URL/" >/dev/null
          curl -fsS -L -m 15 "$BASE_URL/zh-TW" >/dev/null
          curl -fsS -L -m 15 "$BASE_URL/zh-TW/events" >/dev/null

      - name: Smoke check API and DB connectivity
        run: |
          body="$(curl -fsS -m 15 "$BASE_URL/api/public/events")"
          echo "$body" | jq -e '.ok == true' >/dev/null
          echo "$body" | jq -e '.data | type == "array"' >/dev/null
